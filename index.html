<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kalkulator Paparan Getaran A(8) — HSE + SWA (2025)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .status-below-eav { background-color: #28a745; color: #fff; }
    .status-above-eav  { background-color: #ffc107; color: #333; }
    .status-above-elv  { background-color: #dc3545; color: #fff; }
    .legend-work::before { content: ''; display:inline-block; width:12px; height:12px; background:#007bff; margin-right:8px; border-radius:2px; }
    .legend-rest::before { content: ''; display:inline-block; width:12px; height:12px; background:#17a2b8; margin-right:8px; border-radius:2px; }
    .legend-break::before{ content: ''; display:inline-block; width:12px; height:12px; background:#6c757d; margin-right:8px; border-radius:2px; }
    .legend-idle::before { content: ''; display:inline-block; width:12px; height:12px; background:#e9ecef; margin-right:8px; border-radius:2px; }
    .info-container{ position:relative; display:inline-flex; align-items:center; }
    .info-icon{ cursor:pointer; margin-left:8px; font-weight:600; color:#6b7280; border:1px solid #d1d5db; border-radius:50%; width:18px; height:18px; display:inline-flex; justify-content:center; align-items:center; font-size:12px; }
    .tooltip-text{ visibility:hidden; width:300px; background:#333; color:#fff; text-align:left; border-radius:6px; padding:8px 12px; position:absolute; z-index:1; bottom:125%; left:50%; transform:translateX(-50%); opacity:0; transition:opacity .3s; font-size:12px; line-height:1.6; }
    .tooltip-text::after{ content:""; position:absolute; top:100%; left:50%; margin-left:-5px; border-width:5px; border-style:solid; border-color:#333 transparent transparent transparent; }
    .info-container:hover .tooltip-text{ visibility:visible; opacity:1; }
    @keyframes highlight-input { 0%{ box-shadow:0 0 0 2px rgba(59,130,246,0);} 50%{ box-shadow:0 0 0 3px rgba(59,130,246,.6);} 100%{ box-shadow:0 0 0 2px rgba(59,130,246,0);} }
    .input-highlight{ animation:highlight-input 1.5s ease-out; }
    /* --- DARK MODE & FLASH --- */
    .icon-sun{display:none}
    .dark .icon-sun{display:inline}
    .dark .icon-moon{display:none}
    body.dark{ background-color:#0b1220; }
    .dark .calculator-container{ background-color:#111827; color:#e5e7eb; }
    .dark .output-section{ background-color:#0f172a; }
    .dark .recommendation-section{ background-color:#0b1220; border-color:#2563eb; }
    .dark .schedule-inputs .bg-gray-50{ background-color:#0f172a; border-color:#1f2937; }
    .dark .text-gray-800, .dark .text-gray-700, .dark .text-gray-600, .dark .text-gray-500{ color:#e5e7eb !important; }
    .dark .border-gray-200{ border-color:#1f2937 !important; }
    .dark .tooltip-text{ background:#374151; color:#f9fafb; }
    .dark .tooltip-text::after{ border-color:#374151 transparent transparent transparent; }
    .dark .dark-panel{ background-color:#0f172a; border-color:#1f2937; color:#e5e7eb; }
    .toolbar-btn{ background:#ffffff; color:#374151; border:1px solid #d1d5db; }
    .toolbar-btn:hover{ background:#f3f4f6; }
    .dark .toolbar-btn{ background:#111827; color:#e5e7eb; border-color:#374151; }
    .dark .toolbar-btn:hover{ background:#1f2937; }
    @keyframes flash-amber{0%{box-shadow:0 0 0 0 rgba(245,158,11,0)}30%{box-shadow:0 0 0 6px rgba(245,158,11,0.6)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}
    .flash-amber{animation:flash-amber 1s ease-out}
    @keyframes flash-green{0%{box-shadow:0 0 0 0 rgba(34,197,94,0)}30%{box-shadow:0 0 0 6px rgba(34,197,94,0.6)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    .flash-green{animation:flash-green 1s ease-out}
  :root{--color-work:#007bff;--color-rest:#17a2b8;--color-break:#6c757d;--color-idle:#e9ecef;--color-grid:#e5e7eb}
    body.dark{--color-idle:#475569;--color-grid:#374151}
    .legend-work::before{background-color:var(--color-work)!important}
    .legend-rest::before{background-color:var(--color-rest)!important}
    .legend-break::before{background-color:var(--color-break)!important}
    .legend-idle::before{background-color:var(--color-idle)!important}
    .dark input,.dark select,.dark textarea{background-color:#0f172a;color:#e5e7eb;border-color:#374151}
    .dark input:focus,.dark select:focus,.dark textarea:focus{outline:none;box-shadow:0 0 0 2px rgba(59,130,246,.5);border-color:#2563eb}
    .dark .bg-white{background-color:#0f172a!important}
    /* --- GEMINI MODAL --- */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; }
    .dark .modal-content { background-color: #1f2937; color: #e5e7eb; }
    .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; }
    .dark .modal-close-btn { color: #9ca3af; }
  </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-4">
  <div class="calculator-container bg-white p-4 sm:p-6 md:p-8 rounded-2xl shadow-lg w-full max-w-6xl">
    <header class="border-b pb-4 mb-6 relative">
      <div class="flex items-center justify-end gap-2 mb-4">
        <button id="reset-btn" class="toolbar-btn px-3 py-2 rounded-lg shadow-sm focus:outline-none" title="Reset ke Default">
          <span class="sr-only">Reset ke Default</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>
        </button>
        <button id="formula-btn" class="toolbar-btn px-3 py-2 rounded-lg shadow-sm focus:outline-none" title="Tunjukkan rumus" aria-haspopup="true" aria-expanded="false">
          <span class="sr-only">Tunjukkan rumus</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18M8 8h8M8 16l8-8M3 20h18"/></svg>
        </button>
        <button id="theme-toggle" class="toolbar-btn px-3 py-2 rounded-lg shadow-sm focus:outline-none" title="Mode Gelap / Terang" aria-label="Toggle dark mode">
          <span class="icon-moon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z"/></svg>
          </span>
          <span class="icon-sun">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M2 12h2m16 0h2M5 5l1.5 1.5M17.5 17.5L19 19M19 5l-1.5 1.5M5 19l1.5-1.5"/></svg>
          </span>
        </button>
      </div>
      
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Vibration Exposure Simulation A(8)</h1>
        <p class="text-gray-500 mt-1">Simulasi paparan getaran & manajemen waktu kerja (HSE L140 + SWA Table 2)</p>
      </div>

      <div id="formula-panel" class="hidden absolute right-2 top-16 mt-3 w-[380px] max-w-[90vw] rounded-xl shadow-lg bg-white border p-4 text-sm z-20 dark-panel">
        <div class="font-semibold mb-2">Rumus yang digunakan</div>
        <ul class="list-disc pl-5 space-y-2">
          <li><b>A(8)</b> = Ahv × √(T<sub>op</sub>/8), dengan T<sub>op</sub> = T<sub>total</sub>/n.</li>
          <li><b>Poin HSE</b> ≈ 2 × Ahv² × T<sub>op</sub>.</li>
          <li><b>n (operator min)</b> agar A(8) &lt; 5.0: n = ⌈ T<sub>total</sub> / (8 × (5/Ahv)²) ⌉, dibatasi 1–6.</li>
          <li><b>Penurunan jam otomatis</b> bila n &gt; 6: T<sub>total</sub> → floor_step( (8 × (5/Ahv)²) × 6 − ε ).</li>
        </ul>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      <!-- Left: Inputs -->
      <div class="md:col-span-1">
        <section class="inputs">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Parameter Getaran</h3>
          <div class="space-y-4">
            <div>
              <label for="tool-type" class="block text-xs font-medium text-gray-600 mb-1">Tipe Perkakas (Handtool)</label>
              <select id="tool-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                <option value="" disabled selected>-- Pilih Tipe Perkakas --</option>
              </select>
            </div>

            <div>
              <label for="ahv-input" class="block text-xs font-medium text-gray-600 mb-1">Getaran Alat (Ahv) m/s²</label>
              <input type="number" id="ahv-input" step="0.1" min="0" max="40" value="2.5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" />
              <small id="source-note" class="text-xs text-gray-500 mt-1 block"></small>
            </div>

            <div>
              <label for="tool-hours-input" class="block text-xs font-medium text-gray-600 mb-1">Total Waktu Penggunaan Alat sesuai Net jam kerja</label>
              <div class="relative">
                <input type="number" id="tool-hours-input" step="0.5" min="0" max="6.5" value="6.5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition pr-12" />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <span class="text-gray-500">Jam</span>
                </div>
              </div>
              <small id="intermittent-tool-note" class="text-xs text-amber-600 mt-1 block hidden"></small>
            </div>

            <div>
              <label for="operators-input" class="block text-xs font-medium text-gray-600 mb-1">Jumlah Operator (min)</label>
              <input type="number" id="operators-input" step="1" min="1" max="6" value="1" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" />
            </div>

            <div class="mt-4 pt-4 border-t border-gray-200">
              <label class="block text-xs font-medium text-gray-600 mb-1">Batas Waktu Paparan Operator per Hari</label>
              <p id="max-exposure-limit-display" class="text-lg font-bold text-gray-800">- Jam</p>
            </div>
          </div>
        </section>

        <section class="schedule-inputs mt-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Jadwal Kerja Harian</h3>
          <div class="space-y-2 text-xs bg-gray-50 p-4 rounded-lg border">
            <p><strong>Jam Kerja:</strong> 08:00 - 16:00</p>
            <p><strong>Coffee Break 1:</strong> 09:30 (15 min)</p>
            <p><strong>Istirahat Siang:</strong> 12:00 - 13:00 (60 min)</p>
            <p><strong>Coffee Break 2:</strong> 14:45 (15 min)</p>
            <hr class="my-2" />
            <p class="text-xs"><strong>Total Durasi Shift:</strong> <span id="shift-duration-display" class="text-xs text-gray-700"></span></p>
          </div>
        </section>
      </div>

      <!-- Right: Outputs -->
      <div class="md:col-span-1 lg:col-span-2">
        <section class="output-section bg-gray-50 px-6 py-3 rounded-lg text-center">
          <div class="info-container">
            <h2 class="text-sm font-semibold text-gray-600">HSE Exposure Points (≈ 2×Ahv²×jam)</h2>
            <span class="info-icon" title="Klik untuk info">?</span>
            <span class="tooltip-text">
              <b>EAV (Batas Aksi): 100 poin.</b> Tindakan kontrol getaran harus dimulai.<br />
              <b>ELV (Batas Paparan): 400 poin.</b> Pekerja tidak boleh terpapar di atas level ini.
            </span>
          </div>
          <div id="hse-points-value" class="text-3xl font-bold text-gray-800 my-1">0</div>
          <div class="text-xs text-gray-600">A(8): <span id="a8-value">0.00</span> m/s²</div>
          <div id="status-display" role="status" aria-live="polite" class="text-xs font-semibold p-2 rounded-md transition-all duration-300 mt-2">Calculating...</div>
          <div id="shift-limit-display" class="text-xs text-gray-500 mt-1"></div>
          
          <div class="mt-3">
              <button id="analysis-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                  ✨ Tampilkan Analisis Risiko & Kontrol
              </button>
          </div>
        </section>

        <section class="recommendation-section bg-blue-50 border-l-4 border-blue-500 p-3 my-6 rounded-r-md">
          <h4 class="font-semibold text-blue-800 text-xs">Rekomendasi Siklus Kerja Getaran</h4>
          <p id="per-hour-recommendation" class="text-base font-bold text-blue-600">60' Kerja + 0' Istirahat</p>
          <p class="text-xs text-gray-500 mt-1">Rekomendasi umum untuk manajemen risiko; sesuaikan dengan kondisi nyata.</p>
        </section>

        <section class="schedule-section my-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-base font-semibold text-gray-700">Timeline Manajemen Kerja</h3>
            <div id="chart-legend" class="flex space-x-4 text-xs">
              <span class="legend-work">Kerja</span>
              <span class="legend-rest">Istirahat Getaran</span>
              <span class="legend-break">Istirahat Shift</span>
              <span class="legend-idle">Idle</span>
            </div>
          </div>
          <div id="chart-container" class="space-y-1"></div>
        </section>
        
        <section class="disclaimer-section mt-6 bg-gray-50 p-4 rounded-lg border">
            <h4 class="font-semibold text-gray-700 text-xs mb-2">Catatan Penggunaan Alat</h4>
            <p class="text-gray-600 leading-relaxed" style="font-size: 0.7rem;">
                Disclaimer: Alat yang digunakan kemungkinan tidak dioperasikan secara kontinu sesuai dengan kurun waktu pada "Timeline Manajemen Kerja" di atas. Silakan Anda menurunkan waktu penggunaan alat yang efektif pada boks "Total Waktu Penggunaan Alat" sehingga jumlah operator akan berkurang sesuai dengan rencana Anda.
            </p>
        </section>

      </div>
    </div>
  </div>

  <div id="analysis-modal" class="modal-overlay">
      <div class="modal-content">
          <button id="modal-close-btn" class="modal-close-btn">&times;</button>
          <h2 class="text-xl font-bold mb-4">Analisis Risiko & Rekomendasi Kontrol</h2>
          <div id="analysis-output">
              <!-- Static content will be injected here -->
          </div>
      </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- CONSTANTS ---
      const EAV_POINTS = 100; const ELV_POINTS = 400; const POINTS_FACTOR = 2; const ELV_A8 = 5; const TIME_BLOCK_MINUTES = 15;

      // --- SCHEDULE (STATIC) ---
      const staticSchedule = {
        workStart: '08:00', workEnd: '16:00', break1Start: '09:30', break1Duration: 15,
        lunchStart: '12:00',  lunchDuration: 60, break2Start: '14:45', break2Duration: 15,
      };

      // --- DATASETS ---
      const HSE_TOOLS = {
        'drill-standard':{name:'Bor - Mata Standar',ahv:5,src:'HSE L140 Table 6', intermittent: true},'drill-hole-saw':{name:'Bor - Hole Saw',ahv:10,src:'HSE L140 Table 6'},'drill-core-78-107':{name:'Bor Inti (Core) 78–107 mm',ahv:8,src:'HSE L140 Table 6'},'drill-impact-masonry':{name:'Bor Impact (5–8 mm, masonry)',ahv:11,src:'HSE L140 Table 6', intermittent: true},'angle-grinder-100-180':{name:'Gerinda Sudut 100–180 mm',ahv:7,src:'HSE L140 Table 6'},'angle-grinder-flap-100-125':{name:'Gerinda Sudut 100/125 mm (Flap)',ahv:4,src:'HSE L140 Table 6'},'angle-grinder-220-300':{name:'Gerinda Sudut 220–300 mm',ahv:9,src:'HSE L140 Table 6'},'die-grinder':{name:'Gerinda Die',ahv:8,src:'HSE L140 Table 6'},'straight-grinder':{name:'Gerinda Lurus (Straight)',ahv:8,src:'HSE L140 Table 6'},'nail-gun':{name:'Paku Tembak (Nail Gun)',ahv:9,src:'HSE L140 Table 6', intermittent: true},'needle-scaler-nonvr':{name:'Needle Scaler (non-VR)',ahv:19,src:'HSE L140 Table 6'},'needle-scaler-vr':{name:'Needle Scaler (VR)',ahv:7,src:'HSE L140 Table 6'},'nibbler':{name:'Nibbler',ahv:12,src:'HSE L140 Table 6'},'sander-orbital':{name:'Sander Orbital',ahv:9,src:'HSE L140 Table 6'},'polisher-angle-hand':{name:'Polisher Sudut (hand-held)',ahv:3,src:'HSE L140 Table 6'},'breaker-vr':{name:'Breaker (VR; handle/bodi suspensi)',ahv:14,src:'HSE L140 Table 6', intermittent: true},'demolition-rotary-hammer':{name:'Hammer Demolition/Rotary',ahv:18,src:'HSE L140 Table 6', intermittent: true},'plate-compactor-nonvr':{name:'Plate Compactor (non-VR)',ahv:18,src:'HSE L140 Table 6'},'plate-compactor-vr':{name:'Plate Compactor (VR)',ahv:4,src:'HSE L140 Table 6'},'pneumatic-hammer':{name:'Hammer Pneumatik',ahv:25,src:'HSE L140 Table 6', intermittent: true},'cutoff-saw-masonry':{name:'Cut-off Saw (Masonry)',ahv:13,src:'HSE L140 Table 6'},'scabbler':{name:'Scabbler',ahv:12,src:'HSE L140 Table 6'},'trench-rammer':{name:'Trench Rammer',ahv:13,src:'HSE L140 Table 6'},'water-jetting-gun':{name:'Water-jetting Gun',ahv:4,src:'HSE L140 Table 6'},'chainsaw':{name:'Gergaji Rantai (Chainsaw)',ahv:7,src:'HSE L140 Table 6'},'hedge-trimmer':{name:'Pemangkas Pagar (Hedge Trimmer)',ahv:6,src:'HSE L140 Table 6'},'mower-hand':{name:'Mesin Potong Rumput – Hand-guided',ahv:7,src:'HSE L140 Table 6'},'mower-rideon':{name:'Mesin Potong Rumput – Ride-on',ahv:6,src:'HSE L140 Table 6'},'strimmer':{name:'Strimmer/Brushcutter (String)',ahv:7,src:'HSE L140 Table 6'},'chipping-hammer-weld':{name:'Chipping Hammer (Weld)',ahv:31,src:'HSE L140 Table 6', intermittent: true},'impact-wrench-small':{name:'Impact Wrench 3/8"–3/4"',ahv:5,src:'HSE L140 Table 6', intermittent: true},'impact-wrench-1in':{name:'Impact Wrench 1"',ahv:10,src:'HSE L140 Table 6', intermittent: true},'pedestal-grinder':{name:'Gerinda Duduk (Pedestal)',ahv:8,src:'HSE L140 Table 6'},
      };
      const SWA_TOOLS = {
        'swa-road-breaker':{name:'Road breaker / Jackhammer (SWA)',ahv:12,best:5,worst:20,src:'SWA Table 2', intermittent: true},'swa-demolition-hammer':{name:'Demolition hammer (SWA)',ahv:15,best:8,worst:25,src:'SWA Table 2', intermittent: true},'swa-hammer-drill-combi':{name:'Hammer drill / Combi hammer (SWA)',ahv:9,best:6,worst:25,src:'SWA Table 2', intermittent: true},'swa-needle-scaler':{name:'Needle scaler (SWA)',ahv:6,best:5,worst:25,typicalLo:5,typicalHi:7,src:'SWA Table 2'},'swa-scabbler':{name:'Scabbler – hammer type (SWA)',ahv:30,best:20,worst:40,typicalLo:20,typicalHi:40,src:'SWA Table 2'},'swa-angle-grinder-large':{name:'Angle grinder (large) (SWA)',ahv:6,best:4,worst:8,src:'SWA Table 2'},'swa-angle-grinder-small':{name:'Angle grinder (small) (SWA)',ahv:4,best:2,worst:6,typicalLo:2,typicalHi:6,src:'SWA Table 2'},'swa-clay-spade-jigger':{name:'Clay spade / Jigger pick (SWA)',ahv:16,best:16,worst:16,src:'SWA Table 2'},'swa-chipping-hammer-metal':{name:'Chipping hammer (metal-working) (SWA)',ahv:18,best:10,worst:18,src:'SWA Table 2', intermittent: true},'swa-pneumatic-stone-hammer':{name:'Pneumatic stone-working hammer (SWA)',ahv:10,best:8,worst:30,typicalLo:8,typicalHi:12,src:'SWA Table 2', intermittent: true},'swa-chainsaw':{name:'Chainsaw (SWA)',ahv:6,best:6,worst:6,src:'SWA Table 2'},'swa-brushcutter':{name:'Brushcutter (SWA)',ahv:4,best:2,worst:4,src:'SWA Table 2'},'swa-sander-random-orbital':{name:'Sander (random orbital) (SWA)',ahv:8.5,best:7,worst:10,typicalLo:7,typicalHi:10,src:'SWA Table 2'},
      };
      const allTools = { ...HSE_TOOLS, ...SWA_TOOLS };
      const SIMPLE_KEYS = [
        'drill-impact-masonry', 'angle-grinder-100-180', 'angle-grinder-flap-100-125', 'die-grinder', 'sander-orbital', 
        'demolition-rotary-hammer', 'impact-wrench-small', 'chainsaw', 'needle-scaler-vr', 'plate-compactor-vr'
      ];

      // --- DOM REFS ---
      const DOMElements = {
        toolTypeSelect: document.getElementById('tool-type'), ahvInput: document.getElementById('ahv-input'), toolHoursInput: document.getElementById('tool-hours-input'), 
        operatorsInput: document.getElementById('operators-input'), shiftDurationDisplay: document.getElementById('shift-duration-display'), 
        perHourRec: document.getElementById('per-hour-recommendation'), hsePointsValue: document.getElementById('hse-points-value'), 
        statusDisplay: document.getElementById('status-display'), chartContainer: document.getElementById('chart-container'), 
        shiftLimitDisplay: document.getElementById('shift-limit-display'), maxExposureLimitDisplay: document.getElementById('max-exposure-limit-display'), 
        a8Value: document.getElementById('a8-value'), sourceNote: document.getElementById('source-note'),
        analysisBtn: document.getElementById('analysis-btn'), analysisModal: document.getElementById('analysis-modal'),
        modalCloseBtn: document.getElementById('modal-close-btn'), analysisOutput: document.getElementById('analysis-output'),
        intermittentToolNote: document.getElementById('intermittent-tool-note'),
      };

      // --- HELPERS ---
      const timeToMinutes = (t) => { const [h, m] = t.split(':').map(Number); return h*60 + m; };
      const minutesToHHMM = (m) => { const h = Math.floor(m/60).toString().padStart(2,'0'); const min = (m%60).toString().padStart(2,'0'); return `${h}:${min}`; };
      const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
      function flashChange(el, v='amber'){ const c = v==='green' ? 'flash-green' : 'flash-amber'; el.classList.remove('flash-amber','flash-green'); void el.offsetWidth; el.classList.add(c); setTimeout(()=> el.classList.remove('flash-amber','flash-green'), 1000); }
      function applyTheme(t){ if(t==='dark'){ document.body.classList.add('dark'); } else { document.body.classList.remove('dark'); } try{ localStorage.setItem('theme', t); }catch(_){}}
      function cssVar(n){ return getComputedStyle(document.body).getPropertyValue(n).trim() || '#e5e7eb'; }
      function updateSourceNote(e, u){ if(!DOMElements.sourceNote) return; if(!e){ DOMElements.sourceNote.textContent=''; return; } let n = `Sumber: ${e.src||'N/A'}. Nilai terpakai: ${u?.toFixed?u.toFixed(1):u} m/s².`; if(e.typicalLo!=null && e.typicalHi!=null) n += ` Kisaran tipikal: ${e.typicalLo}–${e.typicalHi} m/s².`; if((e.best!=null || e.worst!=null) && (e.src||'').toUpperCase().includes('SWA')){ n += ` [Best≈${e.best??'—'}, Worst≈${e.worst??'—'}]`; } DOMElements.sourceNote.textContent = n; }
      function deriveAhv(e){ if(!e) return parseFloat(DOMElements.ahvInput.value)||0; if((e.src||'').toUpperCase().includes('SWA') && e.typicalLo!=null && e.typicalHi!=null) return (e.typicalLo + e.typicalHi)/2; return e.ahv; }
      function populateToolOptions() { const s=DOMElements.toolTypeSelect; s.innerHTML=''; s.add(new Option('-- Pilih Tipe Perkakas --','',true,true)); s.options[0].disabled=true; s.add(new Option('-- Masukkan Manual --','custom')); const g=document.createElement('optgroup'); g.label='Umum Dipakai'; SIMPLE_KEYS.forEach(k=>{if(allTools[k]){g.appendChild(new Option(allTools[k].name,k));}}); s.appendChild(g); const c={'Pengeboran & Pengencangan':['drill','bor','wrench','nail'],'Pemotongan & Penggerindaan':['grinder','gerinda','saw','nibbler','cutoff'],'Palu & Pembongkaran':['hammer','breaker','scaler','scabbler','compactor','rammer','spade','pick'],'Pekerjaan Kayu & Taman':['chainsaw','hedge','mower','strimmer','brushcutter'],'Lain-lain':['polisher','sander','jetting']}; const grps={}; Object.keys(c).forEach(n=>{grps[n]=document.createElement('optgroup'); grps[n].label=n;}); const categorized=new Set(SIMPLE_KEYS); Object.entries(allTools).forEach(([k,t])=>{if(categorized.has(k))return; let a=false; const l=t.name.toLowerCase(); for(const [n,w] of Object.entries(c)){if(w.some(kw=>l.includes(kw))){grps[n].appendChild(new Option(t.name,k));a=true;break;}} if(!a){grps['Lain-lain'].appendChild(new Option(t.name,k));}}); Object.values(grps).forEach(g=>{if(g.children.length>0){s.appendChild(g);}}); }

      // --- CORE CALC ---
      function calculateAndUpdate(){ const ws=timeToMinutes(staticSchedule.workStart),we=timeToMinutes(staticSchedule.workEnd); const tsm=Math.max(0,we-ws); const tbm=staticSchedule.break1Duration+staticSchedule.lunchDuration+staticSchedule.break2Duration; const nwm=Math.max(0,tsm-tbm); const nwh=nwm/60; DOMElements.shiftDurationDisplay.textContent=`${(tsm/60).toFixed(2)} jam (Net: ${nwh.toFixed(2)} jam)`; DOMElements.toolHoursInput.max=nwh.toFixed(2); let ahv=parseFloat(DOMElements.ahvInput.value)||0; ahv=clamp(ahv,0,40); DOMElements.ahvInput.value=ahv; let tth=parseFloat(DOMElements.toolHoursInput.value)||0; tth=clamp(tth,0,nwh); DOMElements.toolHoursInput.value=tth.toFixed(2); let ops=parseInt(DOMElements.operatorsInput.value)||1; ops=clamp(ops,1,6); DOMElements.operatorsInput.value=ops; let denom= (ahv>0)?8*Math.pow(ELV_A8/ahv,2):Infinity; const step=parseFloat(DOMElements.toolHoursInput.step)||0.5; let recOps=1; if(isFinite(denom)&&tth>0){recOps=Math.ceil(tth/denom);} if(recOps>6&&isFinite(denom)){const max6=denom*6-1e-9; const q=Math.max(0,Math.floor(max6/step)*step); const c=clamp(q,0,nwh); if(c<tth-1e-9){tth=c; DOMElements.toolHoursInput.value=tth.toFixed(2); flashChange(DOMElements.toolHoursInput,'amber');} recOps=(tth>0&&isFinite(denom))?Math.ceil(tth/denom):1;} let numOps=clamp(Math.max(1,recOps),1,6); if(numOps!==ops){DOMElements.operatorsInput.value=numOps; flashChange(DOMElements.operatorsInput,'green');} else {DOMElements.operatorsInput.value=numOps;} if(numOps===6&&isFinite(denom)){const smax6=denom*6-1e-9; if(tth>=smax6-1e-12){const q6=Math.max(0,Math.floor(smax6/step)*step); const c6=clamp(q6,0,nwh); if(c6<tth-1e-9){tth=c6; DOMElements.toolHoursInput.value=tth.toFixed(2); flashChange(DOMElements.toolHoursInput,'amber');}}} const ept=(numOps>0)?tth/numOps:0; const hse=POINTS_FACTOR*ahv*ahv*ept; const a8v=(ept>0)?ahv*Math.sqrt(ept/8):0; updateStatusDisplay(hse,a8v); DOMElements.shiftLimitDisplay.textContent=`Batas paparan dibatasi shift Net: ${nwh.toFixed(2)} jam kerja efektif`; updateRecommendation(ahv); updateMaxExposureLimit(ahv); const sch={workStartMins:ws,workEndMins:we,breaks:[{start:timeToMinutes(staticSchedule.break1Start),duration:staticSchedule.break1Duration},{start:timeToMinutes(staticSchedule.lunchStart),duration:staticSchedule.lunchDuration},{start:timeToMinutes(staticSchedule.break2Start),duration:staticSchedule.break2Duration}]}; const wmp=ept*60; const wc=calculateWorkCycle(ahv); updateChart(numOps,sch,wmp,wc); persist(); }
      function updateStatusDisplay(p,a){DOMElements.hsePointsValue.textContent=Math.round(p).toString(); DOMElements.a8Value.textContent=a.toFixed(2); const e=DOMElements.statusDisplay; e.className='text-xs font-semibold p-2 rounded-md transition-all duration-300 mt-2'; let statusKey = ''; if(p>=ELV_POINTS){e.textContent=`DI ATAS BATAS PAPARAN (Above ELV: ${a.toFixed(2)} m/s²)`; e.classList.add('status-above-elv'); statusKey = 'elv';} else if(p>=EAV_POINTS){e.textContent=`Di Atas Batas Aksi (Above EAV: ${a.toFixed(2)} m/s²)`; e.classList.add('status-above-eav'); statusKey = 'eav';} else {e.textContent=`Di Bawah Batas Aksi (Below EAV: ${a.toFixed(2)} m/s²)`; e.classList.add('status-below-eav'); statusKey = 'below_eav';} DOMElements.analysisBtn.disabled=p<1; DOMElements.analysisBtn.dataset.statusKey = statusKey; }
      function updateMaxExposureLimit(a){if(a<=0){DOMElements.maxExposureLimitDisplay.textContent='Tidak terbatas';return;} const m=8*Math.pow(ELV_A8/a,2); DOMElements.maxExposureLimitDisplay.textContent=`${m.toFixed(2)} Jam`;}
      function calculateWorkCycle(a){if(a<=0)return{work:60,rest:0}; const m=(EAV_POINTS/(POINTS_FACTOR*a*a))*60; if(m>240)return{work:60,rest:0}; if(m>120)return{work:45,rest:15}; if(m>60)return{work:30,rest:30}; if(m>30)return{work:15,rest:45}; return{work:10,rest:50};}
      function updateRecommendation(a){const c=calculateWorkCycle(a); DOMElements.perHourRec.textContent=`${c.work}' Kerja + ${c.rest}' Istirahat Getaran`;}
      function createTimeline(s){const a=[]; for(let m=s.workStartMins;m<s.workEndMins;m+=TIME_BLOCK_MINUTES){let t='available'; for(const b of s.breaks){if(m>=b.start&&m<b.start+b.duration){t='break';break;}} a.push({time:m,type:t});} return a;}
      function renderTimeAxis(t){const r=document.createElement('div'); r.className='flex items-center gap-3'; const l=document.createElement('div'); l.className='w-24 flex-shrink-0'; const c=document.createElement('div'); c.className='flex-grow grid border-b-2 border-gray-300'; c.style.gridTemplateColumns=`repeat(${t.length}, 1fr)`; c.style.borderBottom='2px solid '+cssVar('--color-grid'); let lh=-1; t.forEach((b,i)=>{const e=document.createElement('div'); const ch=Math.floor(b.time/60); if(ch!==lh&&b.time%60===0){const hh=ch.toString().padStart(2,'0'); e.innerHTML=`<div class="hidden sm:block text-xs text-gray-500">${hh}:00</div><div class="block sm:hidden text-[10px] text-gray-500 transform -rotate-90 origin-left whitespace-nowrap">${hh}:00</div>`; e.className='text-xs text-gray-500 -ml-2'; lh=ch;} if(b.time%60===0&&i>0){e.style.borderLeft='1px solid '+cssVar('--color-grid');} c.appendChild(e);}); r.appendChild(l); r.appendChild(c); DOMElements.chartContainer.appendChild(r);}
      function renderOperatorChart(i,t){const r=document.createElement('div'); r.className='flex items-center gap-3'; const l=document.createElement('div'); l.className='w-24 text-xs font-medium text-gray-700 flex-shrink-0'; l.textContent=`Operator ${i}`; const c=document.createElement('div'); c.className='flex-grow grid rounded-md overflow-hidden'; c.style.gridTemplateColumns=`repeat(${t.length}, 1fr)`; t.forEach((b,idx)=>{const e=document.createElement('div'); e.className='h-6'; const h=minutesToHHMM(b.time); e.title=`Waktu: ${h}`; if(b.type==='work')e.style.backgroundColor=cssVar('--color-work'); else if(b.type==='rest')e.style.backgroundColor=cssVar('--color-rest'); else if(b.type==='break')e.style.backgroundColor=cssVar('--color-break'); else e.style.backgroundColor=cssVar('--color-idle'); if(b.time%60===0&&idx>0){e.style.borderLeft='1px solid '+cssVar('--color-grid');} c.appendChild(e);}); r.appendChild(l); r.appendChild(c); DOMElements.chartContainer.appendChild(r);}
      function findOperatorWithMostWork(r){return r.indexOf(Math.max(...r));}
      function fillCycleForOperator(t,s,c,m){const wb=Math.min(Math.ceil(c.work/TIME_BLOCK_MINUTES),Math.ceil(m/TIME_BLOCK_MINUTES)); const rb=Math.ceil(c.rest/TIME_BLOCK_MINUTES); let wf=0; let li=s-1; for(let i=0;i<wb;i++){const idx=s+i; if(idx<t.length&&t[idx].type==='available'){t[idx].type='work'; wf+=TIME_BLOCK_MINUTES; li=idx;} else {break;}} for(let i=0;i<rb;i++){const idx=s+wb+i; if(idx<t.length&&t[idx].type==='available'){t[idx].type='rest'; li=idx;} else {break;}} return{work:wf,startIndex:s,lastIndex:li};}
      function updateChart(n,s,w,c){DOMElements.chartContainer.innerHTML=''; const t=createTimeline(s); renderTimeAxis(t); const ot=Array.from({length:n},()=>JSON.parse(JSON.stringify(t))); const r=Array.from({length:n},()=>w); for(let i=0;i<t.length;i++){if(t[i].type!=='available')continue; const o=findOperatorWithMostWork(r); if(r[o]<=0)continue; const f=fillCycleForOperator(ot[o],i,c,r[o]); r[o]-=f.work; for(let j=i;j<=f.lastIndex&&j<t.length;j++){if(t[j].type==='available')t[j].type='taken';} for(let k=0;k<n;k++)if(k!==o){for(let l=f.startIndex;l<=f.lastIndex&&l<ot[k].length;l++){if(ot[k][l].type==='available')ot[k][l].type='idle';}} i=f.lastIndex;} ot.forEach((tl,idx)=>renderOperatorChart(idx+1,tl));}

      // --- STATIC ANALYSIS TEMPLATES ---
      function getStaticAnalysisTemplates(toolName, a8Value) {
        const sup = (n) => `<sup class="text-blue-500 font-semibold ml-1">[${n}]</sup>`;
        const refs = `<h3 class="text-lg font-bold mt-4 pt-3 border-t mb-2">Referensi</h3><div class="text-xs text-gray-500 mt-2 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
            <span>[1] <a href="https://www.hse.gov.uk/pubns/priced/l140.pdf" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">HSE UK Hand-arm vibration — L140</a></span>
            <span>[2] <a href="https://www.safeworkaustralia.gov.au/system/files/documents/1703/guidetomeasuringassessinghandarmvibration.pdf" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">AU Gov Guide to Measuring... Hand-Arm Vibration</a></span>
            <span>[3] <a href="https://www.scielo.br/j/rbeb/a/BDK5twJFSh9vQHHqQtw7GGz/?lang=en" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Measurement... exposure to vibration... to hand-arm</a></span>
            <span>[4] <a href="https://www.sciencedirect.com/science/article/pii/S0169814118304918" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Determination of hand-transmitted vibration risk...</a></span>
            <span>[5] <a href="https://www.researchgate.net/publication/323084149_Evaluation_and_Measurement_of_Hand-Transmitted_Vibrations" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Evaluation and Measurement of Hand-Transmitted Vibrations</a></span>
            <span>[6] <a href="https://www.med.navy.mil/Portals/62/Documents/NMFA/NMCPHC/root/Industrial%20Hygiene/Human-Vibration-Technical-Guide.pdf" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Human Vibration Guide — med.navy.mil</a></span>
            <span>[7] <a href="https://jdih.kemnaker.go.id/asset/data_puu/Permen_5_2018.pdf" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">PERMENAKER No. 5 2018</a></span>
            <span>[8] <a href="https://pesta.bsn.go.id/produk/detail/12373-sni70542019" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">SNI 7054:2019</a></span>
            <span>[9] <a href="https://has-environmental.com/wp-content/uploads/2024/03/SV-103-Hand-Arm-Vibration.pdf" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Pengukuran Getaran Tangan Dosimeter</a></span>
        </div>`;
        
        return {
          below_eav: `
            <h3 class="text-lg font-bold mb-2">Analisis Risiko: Risiko Rendah</h3>
            <p class="text-sm">Paparan getaran untuk <strong>${toolName}</strong> dengan nilai A(8) <strong>${a8Value} m/s²</strong> berada di bawah Batas Aksi (EAV). Risiko pengembangan Hand-Arm Vibration Syndrome (HAVS) dalam skenario ini tergolong rendah, namun praktik kerja yang baik harus tetap dijaga untuk memastikan paparan tetap serendah mungkin (ALARP).${sup(1)+sup(7)}</p>
            <h3 class="text-lg font-bold mt-4 mb-2">Rekomendasi Hirarki Kontrol</h3>
            <h4 class="text-md font-semibold mt-3 mb-1">1. Worker Rotation</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Meskipun di bawah batas, rotasi pekerja tetap menjadi praktik yang baik untuk meminimalkan paparan kumulatif jangka panjang.${sup(2)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">2. Engineering Controls</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Pastikan alat (${toolName}) dalam kondisi prima melalui perawatan rutin untuk menjaga tingkat getaran sesuai spesifikasi pabrikan.${sup(4)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">3. Administrative Controls</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Jadwalkan istirahat singkat secara berkala untuk memungkinkan pemulihan sirkulasi darah pada tangan dan lengan.${sup(6)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">4. Training & Work Technique</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Pastikan operator menggunakan teknik kerja yang benar, seperti tidak menggenggam alat terlalu erat dan membiarkan alat melakukan pekerjaannya.${sup(1)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">5. PPE</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Gunakan sarung tangan untuk menjaga tangan tetap hangat dan kering, yang mendukung sirkulasi darah yang baik. Sarung tangan anti-getaran dapat dipertimbangkan sebagai pelengkap.${sup(5)}</li></ul>
            ${refs}`,
          eav: `
            <h3 class="text-lg font-bold mb-2">Analisis Risiko: Risiko Terkendali</h3>
            <p class="text-sm">Paparan getaran untuk <strong>${toolName}</strong> dengan nilai A(8) <strong>${a8Value} m/s²</strong> telah melampaui Batas Aksi (EAV). Ini adalah level peringatan yang mengharuskan penerapan tindakan kontrol untuk mengurangi risiko. Paparan berkelanjutan pada level ini dapat meningkatkan kemungkinan terjadinya gangguan kesehatan seperti HAVS.${sup(1)+sup(7)}</p>
            <h3 class="text-lg font-bold mt-4 mb-2">Rekomendasi Hirarki Kontrol</h3>
            <h4 class="text-md font-semibold mt-3 mb-1">1. Worker Rotation</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li><strong>Prioritas Utama:</strong> Terapkan skema rotasi pekerja seperti yang disimulasikan untuk membagi total durasi kerja dan memastikan tidak ada satu individu pun yang melebihi batas paparan harian.${sup(2)+sup(8)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">2. Engineering Controls</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Evaluasi kemungkinan penggunaan alat alternatif dengan tingkat getaran (Ahv) yang lebih rendah untuk tugas yang sama.${sup(4)}</li><li>Lakukan perawatan preventif pada alat untuk memastikan komponen peredam getaran berfungsi optimal.${sup(5)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">3. Administrative Controls</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Implementasikan istirahat terstruktur (misalnya, 10 menit setiap jam) dari pekerjaan yang melibatkan getaran.${sup(6)}</li><li>Kurangi total waktu penggunaan alat per hari jika memungkinkan, seperti yang disarankan oleh kalkulator ini.${sup(1)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">4. Training & Work Technique</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Berikan pelatihan penyegaran kepada operator mengenai risiko HAVS dan teknik kerja yang aman untuk meminimalkan paparan.${sup(2)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">5. PPE</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Wajibkan penggunaan sarung tangan anti-getaran yang memenuhi standar ISO 10819 sebagai kontrol tambahan.${sup(5)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">6. Pengukuran dan Lain-lain</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Laksanakan program pengawasan kesehatan (health surveillance) bagi semua operator yang terpapar di atas EAV untuk deteksi dini gejala HAVS.${sup(1)+sup(7)}</li></ul>
            ${refs}`,
          elv: `
            <h3 class="text-lg font-bold mb-2 text-red-600">Analisis Risiko: Risiko Tinggi (Tidak Diizinkan)</h3>
            <p class="text-sm"><strong>PERINGATAN:</strong> Paparan getaran untuk <strong>${toolName}</strong> dengan nilai A(8) <strong>${a8Value} m/s²</strong> telah melampaui Batas Nilai Paparan (ELV). Skenario kerja ini <strong>TIDAK DIIZINKAN</strong> dan harus dihentikan segera. Risiko kerusakan kesehatan permanen (HAVS) sangat tinggi.${sup(1)+sup(7)}</p>
            <h3 class="text-lg font-bold mt-4 mb-2">Rekomendasi Hirarki Kontrol (Tindakan Segera)</h3>
            <h4 class="text-md font-semibold mt-3 mb-1">1. Worker Rotation</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Rotasi pekerja saja tidak cukup pada level ini. Tindakan rekayasa dan administratif yang lebih signifikan harus menjadi prioritas utama.${sup(2)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">2. Engineering Controls</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li><strong>Hentikan Penggunaan Alat:</strong> Segera hentikan penggunaan alat ini hingga rencana kontrol yang memadai tersedia.${sup(1)}</li><li><strong>Substitusi Wajib:</strong> Cari dan gunakan metode kerja alternatif yang tidak melibatkan getaran atau gunakan alat dengan nilai Ahv yang jauh lebih rendah.${sup(4)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">3. Administrative Controls</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li><strong>Desain Ulang Pekerjaan:</strong> Rancang ulang proses kerja untuk secara drastis mengurangi total waktu penggunaan alat hingga paparan berada di bawah EAV, bukan hanya ELV.${sup(7)}</li><li>Lakukan investigasi segera untuk memahami mengapa paparan melebihi ELV dan implementasikan tindakan perbaikan.${sup(2)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">4. Training & Work Technique</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Lakukan evaluasi ulang kompetensi dan teknik kerja semua operator yang terlibat.${sup(6)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">5. PPE</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>APD tidak dapat diandalkan sebagai kontrol utama pada tingkat risiko ini, namun tetap wajib digunakan sebagai lapisan pertahanan terakhir.${sup(5)}</li></ul>
            <h4 class="text-md font-semibold mt-3 mb-1">6. Pengukuran dan Lain-lain</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Segera masukkan semua pekerja yang terlibat ke dalam program pengawasan kesehatan intensif.${sup(1)+sup(7)}</li></ul>
            ${refs}`
        };
      }

      function showStaticAnalysis() {
          const statusKey = DOMElements.analysisBtn.dataset.statusKey;
          if (!statusKey) return;
          
          const selectedToolKey = DOMElements.toolTypeSelect.value;
          const toolName = selectedToolKey !== 'custom' && allTools[selectedToolKey] ? allTools[selectedToolKey].name : 'Alat yang dimasukkan manual';
          const a8Value = DOMElements.a8Value.textContent;

          const templates = getStaticAnalysisTemplates(toolName, a8Value);
          const content = templates[statusKey] || '<p>Analisis tidak tersedia untuk skenario ini.</p>';
          
          DOMElements.analysisOutput.innerHTML = content;
          DOMElements.analysisModal.classList.add('visible');
      }

      // --- EVENTS & STATE ---
      function persist(){ try{ const d={toolType:DOMElements.toolTypeSelect.value,ahv:parseFloat(DOMElements.ahvInput.value)||0,toolHours:parseFloat(DOMElements.toolHoursInput.value)||0,operators:parseInt(DOMElements.operatorsInput.value)||1}; localStorage.setItem('a8Calc',JSON.stringify(d)); }catch(_){} }
      function init(){ try{localStorage.removeItem('a8Calc');}catch(_){} populateToolOptions(); DOMElements.toolTypeSelect.selectedIndex=0; DOMElements.ahvInput.disabled=false; DOMElements.ahvInput.value=2.5; updateSourceNote(null,null); DOMElements.toolHoursInput.value='6.5'; DOMElements.operatorsInput.value='1'; const t=(function(){try{return localStorage.getItem('theme')||'light';}catch(_){return'light';}})(); applyTheme(t); document.getElementById('theme-toggle')?.addEventListener('click',()=>{applyTheme(document.body.classList.contains('dark')?'light':'dark');}); const fb=document.getElementById('formula-btn'),fp=document.getElementById('formula-panel'); fb?.addEventListener('click',e=>{e.stopPropagation(); const o=fp.classList.contains('hidden'); fp.classList.toggle('hidden'); fb.setAttribute('aria-expanded',o?'true':'false');}); fp?.addEventListener('click',e=>e.stopPropagation()); document.addEventListener('click',()=>{if(!fp?.classList.contains('hidden')){fp.classList.add('hidden'); fb?.setAttribute('aria-expanded','false');}}); document.getElementById('reset-btn')?.addEventListener('click',()=>{try{localStorage.removeItem('a8Calc');}catch(_){} populateToolOptions(); DOMElements.toolTypeSelect.selectedIndex=0; DOMElements.ahvInput.disabled=false; DOMElements.ahvInput.value=2.5; updateSourceNote(null,null); DOMElements.toolHoursInput.value='6.5'; DOMElements.operatorsInput.value='1'; calculateAndUpdate();}); DOMElements.toolTypeSelect.addEventListener('change',e=>{DOMElements.toolHoursInput.value='6.5'; handleToolChange(e);}); DOMElements.ahvInput.addEventListener('input',()=>{DOMElements.toolHoursInput.value='6.5'; calculateAndUpdate();}); DOMElements.toolHoursInput.addEventListener('input',()=>{flashChange(DOMElements.toolHoursInput,'amber'); calculateAndUpdate();}); DOMElements.operatorsInput.addEventListener('input',()=>{flashChange(DOMElements.operatorsInput,'green'); calculateAndUpdate();}); DOMElements.analysisBtn.addEventListener('click', showStaticAnalysis); DOMElements.modalCloseBtn.addEventListener('click',()=>{DOMElements.analysisModal.classList.remove('visible');}); DOMElements.analysisModal.addEventListener('click',e=>{if(e.target===DOMElements.analysisModal){DOMElements.analysisModal.classList.remove('visible');}}); calculateAndUpdate(); }
      function handleToolChange(e){
        const k=e.target.value; 
        const noteEl = DOMElements.intermittentToolNote;
        if(k!=='custom'&& allTools[k]){
            const en=allTools[k]; 
            const d=deriveAhv(en); 
            DOMElements.ahvInput.value=d; 
            DOMElements.ahvInput.disabled=true; 
            updateSourceNote(en,d);
            if (en.intermittent) {
                noteEl.textContent = 'Catatan: Alat ini sering digunakan secara intermiten. Pastikan waktu yang dimasukkan adalah total "waktu pemicu" (trigger time) sebenarnya.';
                noteEl.classList.remove('hidden');
            } else {
                noteEl.classList.add('hidden');
            }
        } else {
            DOMElements.ahvInput.disabled=false; 
            DOMElements.ahvInput.focus(); 
            updateSourceNote(null,null);
            noteEl.classList.add('hidden');
        } 
        calculateAndUpdate();
      }
      init();
    });
  </script>
</body>
</html>
